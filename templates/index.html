<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SehatMind - AI Dropout Prediction System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .logo-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 24px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .auth-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .auth-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.high-risk {
            border-left: 5px solid #dc3545;
        }

        .stat-card.medium-risk {
            border-left: 5px solid #ffc107;
        }

        .stat-card.low-risk {
            border-left: 5px solid #28a745;
        }

        .stat-card.total {
            border-left: 5px solid #667eea;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1rem;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .students-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .students-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Ensure all student grids are horizontal and full width */
        #studentsGrid,
        #specificTeacherStudentsGrid {
            display: grid !important;
            width: 100%;
        }

        .student-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
            min-height: 180px;
        }

        .student-card:hover {
            transform: translateY(-5px);
        }

        .student-card.high-risk {
            border-left: 5px solid #dc3545;
        }

        .student-card.medium-risk {
            border-left: 5px solid #ffc107;
        }

        .student-card.low-risk {
            border-left: 5px solid #28a745;
        }

        .student-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .student-info {
            color: #666;
            margin-bottom: 10px;
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .risk-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-badge.high {
            background: #dc3545;
            color: white;
        }

        .risk-badge.medium {
            background: #ffc107;
            color: #333;
        }

        .risk-badge.low {
            background: #28a745;
            color: white;
        }
        
        .risk-badge.safe {
            background: #17a2b8;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        /* Modal form specific styling */
        #studentForm .form-group {
            margin-bottom: 12px;
        }

        #studentForm .form-group label {
            font-size: 13px;
            margin-bottom: 4px;
        }

        #studentForm .form-group input,
        #studentForm .form-group select,
        #studentForm .form-group textarea {
            padding: 8px 10px;
            font-size: 13px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 10px;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-3 {
            margin-bottom: 1rem;
        }

        .mt-3 {
            margin-top: 1rem;
        }

        .d-flex {
            display: flex;
        }

        .justify-content-between {
            justify-content: space-between;
        }

        .align-items-center {
            align-items: center;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        /* Role-based UI Styles */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .role-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .navbar-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .admin-only {
            display: none;
        }

        .admin-teacher-only {
            display: none;
        }

        .student-only {
            display: none;
        }

        .role-admin .admin-only,
        .role-admin .admin-teacher-only {
            display: inline-block;
        }

        .role-teacher .admin-teacher-only {
            display: inline-block;
        }

        .role-student .student-only {
            display: inline-block;
        }

        /* Role-specific sections */
        .role-section {
            display: none;
        }

        .teacher-stats-section {
            margin-top: 30px;
        }

        .specific-teacher-students {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            width: 100%;
        }

        .all-students-section {
            margin-top: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            width: 100%;
        }


        .all-students-section h3 {
            color: #333;
            margin-bottom: 5px;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .all-students-section p {
            color: #666;
            margin-bottom: 0;
        }

        .form-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
        }

        .gap-3 {
            gap: 1rem;
        }

        .specific-teacher-students .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .specific-teacher-students .students-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .specific-teacher-students .students-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .teacher-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .teacher-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }

        .teacher-card h3 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .teacher-card p {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 14px;
        }

        .teacher-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .stat-label {
            font-weight: 500;
            color: #666;
        }

        .stat-value {
            font-weight: bold;
            font-size: 16px;
        }

        .stat-value.high-risk {
            color: #dc3545;
        }

        .stat-value.medium-risk {
            color: #ffc107;
        }

        .stat-value.low-risk {
            color: #28a745;
        }

        .role-admin .admin-section {
            display: block;
        }

        .role-teacher .teacher-section {
            display: block;
        }

        .role-student .student-section {
            display: block;
        }

        /* Student Profile Card */
        .student-profile {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            margin-right: 20px;
            position: relative;
            overflow: hidden;
        }

        .profile-info h3 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .profile-info p {
            margin: 0;
            color: #666;
        }

        .risk-indicator {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: auto;
        }

        .risk-indicator.high {
            background: #dc3545;
            color: white;
        }

        .risk-indicator.medium {
            background: #ffc107;
            color: #333;
        }

        .risk-indicator.low {
            background: #28a745;
            color: white;
        }

        /* User Management Table */
        .users-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .role-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-tag.admin {
            background: #dc3545;
            color: white;
        }

        .role-tag.teacher {
            background: #007bff;
            color: white;
        }

        .role-tag.student {
            background: #28a745;
            color: white;
        }

        /* Form rows for student profile */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* Recommendations styling */
        .recommendation-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #ddd;
        }
        
        .recommendation-card.high {
            border-left-color: #dc3545;
        }
        
        .recommendation-card.medium {
            border-left-color: #ffc107;
        }
        
        .recommendation-card.low {
            border-left-color: #28a745;
        }
        
        .recommendation-card.success {
            border-left-color: #17a2b8;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .recommendation-header h4 {
            margin: 0;
            color: #333;
            font-size: 1.2rem;
        }
        
        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .priority-badge.high {
            background: #dc3545;
            color: white;
        }
        
        .priority-badge.medium {
            background: #ffc107;
            color: #333;
        }
        
        .priority-badge.low {
            background: #28a745;
            color: white;
        }
        
        .priority-badge.success {
            background: #17a2b8;
            color: white;
        }
        
        .recommendation-progress {
            margin-bottom: 15px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
        }
        
        .recommendation-actions h5 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1rem;
        }
        
        .recommendation-actions ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .recommendation-actions li {
            margin-bottom: 8px;
            color: #555;
            line-height: 1.4;
        }

        /* Progress Modal Styling */
        .progress-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .metric-card h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .progress-recommendations {
            margin: 30px 0;
        }

        .progress-recommendations h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .progress-actions {
            margin: 30px 0;
        }

        .progress-actions h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .progress-actions ul {
            list-style: none;
            padding: 0;
        }

        .progress-actions li {
            background: #f8f9fa;
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .students-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <div>
                    <h1>SehatMind</h1>
                    <p>AI-based Dropout Prediction and Counseling System</p>
                </div>
            </div>
        </div>

        <!-- Alert Messages -->
        <div id="alert" class="alert"></div>

        <!-- Authentication Section -->
        <div id="authSection" class="auth-section active">
            <div class="text-center mb-3">
                <h2>Welcome to SehatMind</h2>
                <p>Please login to access the dashboard</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Login</button>
            </form>
            
            <div class="text-center mt-3">
                <p>Don't have an account? <a href="#" id="showRegister">Register here</a></p>
            </div>
        </div>

        <!-- Registration Section -->
        <div id="registerSection" class="auth-section">
            <div class="text-center mb-3">
                <h2>Create Account</h2>
                <p>Register for a new account</p>
            </div>
            
            <form id="registerForm">
                <div class="form-group">
                    <label for="regName">Full Name</label>
                    <input type="text" id="regName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="regUsername">Username</label>
                    <input type="text" id="regUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email</label>
                    <input type="email" id="regEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">Password</label>
                    <input type="password" id="regPassword" name="password" required>
                </div>
                <div class="form-group">
                    <label for="regRole">Role</label>
                    <select id="regRole" name="role" required>
                        <option value="teacher">Teacher</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Register</button>
            </form>
            
            <div class="text-center mt-3">
                <p>Already have an account? <a href="#" id="showLogin">Login here</a></p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <!-- Navigation Bar -->
            <div class="navbar">
                <div class="navbar-brand">
                    <h2>SehatMind Dashboard</h2>
                    <span id="userRole" class="role-badge"></span>
                </div>
                <div class="navbar-actions">
                    <button id="addStudentBtn" class="btn admin-teacher-only">Add Student</button>
                    <button id="predictRiskBtn" class="btn admin-teacher-only">Predict Risk</button>
                    <button id="importBtn" class="btn admin-teacher-only">Import CSV</button>
                    <button id="logoutBtn" class="btn">Logout</button>
                </div>
            </div>

            <!-- Statistics -->
            <div id="statsGrid" class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-number" id="totalStudents">0</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card high-risk">
                    <div class="stat-number" id="highRiskStudents">0</div>
                    <div class="stat-label">High Risk</div>
                </div>
                <div class="stat-card medium-risk">
                    <div class="stat-number" id="mediumRiskStudents">0</div>
                    <div class="stat-label">Medium Risk</div>
                </div>
                <div class="stat-card low-risk">
                    <div class="stat-number" id="lowRiskStudents">0</div>
                    <div class="stat-label">Low Risk</div>
                </div>
            </div>

            <!-- Role-specific Content -->
            
            <!-- Admin Section -->
            <div class="role-section admin-section">
                <div class="users-table">
                    <h3>User Management</h3>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <p>Manage system users and their roles</p>
                        <button id="addUserBtn" class="btn">Add User</button>
                    </div>
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr>
                                <td colspan="5" class="text-center">Loading users...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="teacher-stats-section">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h3 id="teacherStatsTitle">Teacher Statistics</h3>
                            <p id="teacherStatsSubtitle">Overview of teachers and their student counts</p>
                        </div>
                        <button id="viewAllStudentsBtn" class="btn" style="display: none;">View All Students</button>
                    </div>
                    <div id="teacherStats" class="teacher-stats-grid">
                        <!-- Teacher stats will be loaded here -->
                    </div>
                </div>
                
                
                <div id="specificTeacherStudents" class="specific-teacher-students" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h3 id="specificTeacherTitle">Students of [Teacher Name]</h3>
                            <p>Students managed by this teacher</p>
                        </div>
                        <button id="backToStatsBtn" class="btn">Back to Teacher Stats</button>
                    </div>
                    <div id="specificTeacherStudentsGrid" class="students-grid">
                        <!-- Specific teacher's students will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Teacher Section -->
            <div class="role-section teacher-section">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>My Students</h3>
                    <div class="d-flex gap-2">
                        <button id="teacherImportBtn" class="btn">Import Students</button>
                    </div>
                </div>
            </div>

            <!-- Student Section -->
            <div class="role-section student-section">
                <!-- Student Profile Display -->
                <div id="studentProfileDisplay" class="student-profile" style="display: none;">
                    <div class="profile-header">
                        <div class="profile-avatar" id="profileAvatar">
                            <img id="profileImage" src="" alt="Profile" style="display: none; width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            <i class="fas fa-user" id="defaultAvatar"></i>
                            <input type="file" id="profileImageInput" accept="image/*" style="display: none;">
                            <button id="changeProfileBtn" class="btn btn-sm" style="position: absolute; bottom: -5px; right: -5px; padding: 2px 6px; font-size: 0.7rem;">ðŸ“·</button>
                        </div>
                        <div class="profile-info">
                            <h3 id="profileStudentName">Loading...</h3>
                            <p id="profileStudentEmail">Loading...</p>
                            <p id="profileStudentCourse">Loading...</p>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center align-items-center" style="gap: 20px; margin-top: 20px;">
                        <button id="editProfileBtn" class="btn">Edit My Profile</button>
                        <div id="studentRiskDisplay" class="risk-display" style="display: inline-block; padding: 10px 20px; border-radius: 25px; font-weight: bold; font-size: 1.1rem;">
                            <!-- Risk level will be displayed here -->
                        </div>
                        <button id="viewProgressBtn" class="btn">View Progress</button>
                    </div>
                </div>

                <!-- Student Profile Form (One-time setup) -->
                <div id="studentProfileForm" class="student-profile" style="display: none;">
                    <h3>Complete Your Profile</h3>
                    <p>Please fill in your details to get personalized recommendations.</p>
                    <form id="studentProfileSetupForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileStudentId">Student ID</label>
                                <input type="text" id="profileStudentId" name="student_id" required>
                            </div>
                            <div class="form-group">
                                <label for="studentPhone">Phone Number</label>
                                <input type="tel" id="studentPhone" name="phone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileStudentCourseInput">Course</label>
                                <input type="text" id="profileStudentCourseInput" name="course" required>
                            </div>
                            <div class="form-group">
                                <label for="profileStudentSemester">Semester</label>
                                <input type="number" id="profileStudentSemester" name="semester" min="1" max="8" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileAttendancePercentage">Attendance %</label>
                                <input type="number" id="profileAttendancePercentage" name="attendance_percentage" min="0" max="100" required>
                            </div>
                            <div class="form-group">
                                <label for="profileCgpa">CGPA</label>
                                <input type="number" id="profileCgpa" name="cgpa" min="0" max="10" step="0.01" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="profileAssignmentsSubmitted">Assignments Submitted</label>
                                <input type="number" id="profileAssignmentsSubmitted" name="assignments_submitted" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="profileAssignmentsTotal">Total Assignments</label>
                                <input type="number" id="profileAssignmentsTotal" name="assignments_total" min="0" required>
                            </div>
                            <div class="form-group">
                                <label for="profileTeacherSelect">Select Your Teacher:</label>
                                <select id="profileTeacherSelect" name="teacher_id" required>
                                    <option value="">Choose your teacher...</option>
                                </select>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn">Save Profile</button>
                        </div>
                    </form>
                </div>

                <!-- Student Recommendations -->
                <div id="studentRecommendations" class="student-profile" style="display: none;">
                    <h3>Personalized Recommendations</h3>
                    <div id="recommendationsList">
                        <!-- Recommendations will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Students Grid (Admin & Teacher) -->
            <div id="allStudentsSection" class="all-students-section admin-teacher-only" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h3>All Students</h3>
                        <p>Complete list of all students in the system</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <select id="riskFilter" class="form-select" style="width: auto;">
                            <option value="">All Risk Levels</option>
                            <option value="high">High Risk</option>
                            <option value="medium">Medium Risk</option>
                            <option value="low">Low Risk</option>
                        </select>
                    </div>
                </div>
                <div id="studentsGrid" class="students-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading students...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Student Details</h2>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                <div class="form-group">
                    <label for="studentIdInput">Student ID</label>
                    <input type="text" id="studentIdInput" name="student_id" required placeholder="Enter Student ID">
                </div>
                <div class="form-group">
                    <label for="studentName">Name</label>
                    <input type="text" id="studentName" name="name" required placeholder="Enter Student Name">
                </div>
                <div class="form-group">
                    <label for="studentEmail">Email</label>
                    <input type="email" id="studentEmail" name="email" required placeholder="Enter Email Address">
                </div>
                <div class="form-group">
                    <label for="studentPhone">Phone</label>
                    <input type="tel" id="studentPhone" name="phone" placeholder="Enter Phone Number">
                </div>
                <div class="form-group">
                    <label for="studentCourse">Course</label>
                    <input type="text" id="studentCourse" name="course" required placeholder="Enter Course Name">
                </div>
                <div class="form-group">
                    <label for="studentSemester">Semester</label>
                    <input type="number" id="studentSemester" name="semester" required>
                </div>
                <div class="form-group">
                    <label for="attendancePercentage">Attendance %</label>
                    <input type="number" id="attendancePercentage" name="attendance_percentage" min="0" max="100" step="0.1">
                </div>
                <div class="form-group">
                    <label for="cgpa">CGPA</label>
                    <input type="number" id="cgpa" name="cgpa" min="0" max="10" step="0.1">
                </div>
                <div class="form-group">
                    <label for="assignmentsSubmitted">Assignments Submitted</label>
                    <input type="number" id="assignmentsSubmitted" name="assignments_submitted" min="0">
                </div>
                <div class="form-group">
                    <label for="assignmentsTotal">Total Assignments</label>
                    <input type="number" id="assignmentsTotal" name="assignments_total" min="0">
                </div>
                <div class="form-group teacher-selection" style="display: none;">
                    <label for="teacherSelect">Select Teacher:</label>
                    <select id="teacherSelect" name="teacher_id">
                        <option value="">Choose teacher...</option>
                    </select>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn">Save</button>
                    <button type="button" id="deleteStudentBtn" class="btn" style="background: #dc3545;">Delete</button>
                    <button type="button" id="closeModalBtn" class="btn" style="background: #6c757d;">Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Import Students from CSV</h2>
            <form id="importForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="csvFile">Select CSV File</label>
                    <input type="file" id="csvFile" name="file" accept=".csv" required>
                </div>
                <button type="submit" class="btn">Import</button>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="addUserModalTitle">Add New User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="addUsername">Username</label>
                    <input type="text" id="addUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="addEmail">Email</label>
                    <input type="email" id="addEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="addPassword">Password</label>
                    <input type="password" id="addPassword" name="password" required>
                </div>
                <div class="form-group">
                    <label for="addRole">Role</label>
                    <select id="addRole" name="role" required>
                        <option value="teacher">Teacher</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn">Add User</button>
                    <button type="button" class="btn" style="background: #6c757d;" onclick="closeAddUserModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Predict Risk Modal -->
    <div id="predictRiskModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="predictRiskModalTitle">Predict Student Risk</h2>
            <form id="predictRiskForm">
                <div class="form-group">
                    <label for="predictCGPA">CGPA (0-10):</label>
                    <input type="number" id="predictCGPA" name="cgpa" min="0" max="10" step="0.1" required>
                </div>
                <div class="form-group">
                    <label for="predictAttendance">Attendance % (0-100):</label>
                    <input type="number" id="predictAttendance" name="attendance" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <label for="predictAssignments">Assignments Completed (out of 10):</label>
                    <input type="number" id="predictAssignments" name="assignments" min="0" max="10" required>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn">Predict Risk</button>
                    <button type="button" class="btn" style="background: #6c757d;" onclick="closePredictRiskModal()">Cancel</button>
                </div>
            </form>
            <div id="riskResult" style="display: none; margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center;">
                <h3 id="riskPercentage"></h3>
                <p id="riskLevel"></p>
                <p id="riskDescription"></p>
            </div>
        </div>
    </div>

    <!-- Student Progress Modal -->
    <div id="studentProgressModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close">&times;</span>
            <h2 id="progressModalTitle">Academic Progress Report</h2>
            <div id="progressContent">
                <div class="progress-summary">
                    <h3>Current Performance Overview</h3>
                    <div class="progress-metrics">
                        <div class="metric-card">
                            <h4>Academic Performance</h4>
                            <div class="metric-value" id="progressCGPA">-</div>
                            <div class="metric-label">CGPA</div>
                        </div>
                        <div class="metric-card">
                            <h4>Attendance</h4>
                            <div class="metric-value" id="progressAttendance">-</div>
                            <div class="metric-label">Percentage</div>
                        </div>
                        <div class="metric-card">
                            <h4>Assignments</h4>
                            <div class="metric-value" id="progressAssignments">-</div>
                            <div class="metric-label">Completion Rate</div>
                        </div>
                        <div class="metric-card">
                            <h4>Risk Level</h4>
                            <div class="metric-value" id="progressRisk">-</div>
                            <div class="metric-label">Current Status</div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-recommendations">
                    <h3>Improvement Areas</h3>
                    <div id="progressRecommendations">
                        <!-- Recommendations will be loaded here -->
                    </div>
                </div>
                
                <div class="progress-actions">
                    <h3>Next Steps</h3>
                    <ul id="progressNextSteps">
                        <!-- Next steps will be loaded here -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="editUserModalTitle">Edit User</h2>
            <form id="editUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-group">
                    <label for="editUsername">Username</label>
                    <input type="text" id="editUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" name="email" required>
                </div>
                <div class="form-group">
                    <label for="editRole">Role</label>
                    <select id="editRole" name="role" required>
                        <option value="admin">Admin</option>
                        <option value="teacher">Teacher</option>
                        <option value="student">Student</option>
                    </select>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn">Update User</button>
                    <button type="button" class="btn" style="background: #6c757d;" onclick="closeEditUserModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // Global variables
        let currentUser = null;
        let students = [];
        let teachers = [];

        // DOM elements
        const authSection = document.getElementById('authSection');
        const registerSection = document.getElementById('registerSection');
        const dashboard = document.getElementById('dashboard');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const studentsGrid = document.getElementById('studentsGrid');
        const studentModal = document.getElementById('studentModal');
        const importModal = document.getElementById('importModal');
        const alertDiv = document.getElementById('alert');

        // Event listeners
        document.getElementById('showRegister').addEventListener('click', () => {
            authSection.classList.remove('active');
            registerSection.classList.add('active');
        });

        document.getElementById('showLogin').addEventListener('click', () => {
            registerSection.classList.remove('active');
            authSection.classList.add('active');
        });

        loginForm.addEventListener('submit', handleLogin);
        registerForm.addEventListener('submit', handleRegister);
        document.getElementById('logoutBtn').addEventListener('click', handleLogout);
        // Event listener will be added after function definition
        document.getElementById('predictRiskBtn').addEventListener('click', predictRisk);
        document.getElementById('importBtn').addEventListener('click', () => openImportModal());
        document.getElementById('studentForm').addEventListener('submit', handleStudentSubmit);
        document.getElementById('deleteStudentBtn').addEventListener('click', handleDeleteStudent);
        document.getElementById('closeModalBtn').addEventListener('click', closeStudentModal);
        document.getElementById('importForm').addEventListener('submit', handleImport);
        document.getElementById('editUserForm').addEventListener('submit', handleEditUser);

        // Close modals
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', (e) => {
                e.target.closest('.modal').style.display = 'none';
            });
        });

        // Functions
        function showAlert(message, type = 'success') {
            alertDiv.textContent = message;
            alertDiv.className = `alert ${type}`;
            alertDiv.style.display = 'block';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const formData = new FormData(loginForm);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    currentUser = result.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showAlert('Login successful!');
                    loadDashboard();
                } else {
                    showAlert(result.error || 'Login failed', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const formData = new FormData(registerForm);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('Registration successful! Please login.');
                    registerSection.classList.remove('active');
                    authSection.classList.add('active');
                    registerForm.reset();
                } else {
                    showAlert(result.error || 'Registration failed', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            authSection.classList.add('active');
            dashboard.classList.remove('active');
            registerSection.classList.remove('active');
        }

        async function loadDashboard() {
            // First verify the session is still valid and get current user
            try {
                const response = await fetch('/api/dashboard/stats', {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.log('Session expired, redirecting to login');
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                    authSection.classList.add('active');
                    dashboard.classList.remove('active');
                    registerSection.classList.remove('active');
                    return;
                }
                
                // Get current user from server to ensure we have the latest info
                const userResponse = await fetch('/api/current-user', {
                    credentials: 'include'
                });
                
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    currentUser = userData.user;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                }
            } catch (error) {
                console.log('Session verification failed, redirecting to login');
                currentUser = null;
                localStorage.removeItem('currentUser');
                authSection.classList.add('active');
                dashboard.classList.remove('active');
                registerSection.classList.remove('active');
                return;
            }
            
            authSection.classList.remove('active');
            registerSection.classList.remove('active');
            dashboard.classList.add('active');
            
            // Set role-based UI
            setRoleBasedUI();
            
            await loadStats();
            await loadTeachers();
            
            // Load role-specific content
            if (currentUser.role === 'admin') {
                console.log('Loading admin dashboard...');
                console.log('Current user role:', currentUser.role);
                // Show admin section and hide others
                const adminSection = document.querySelector('.admin-section');
                console.log('Admin section element:', adminSection);
                adminSection.style.display = 'block';
                document.querySelector('.teacher-section').style.display = 'none';
                document.querySelector('.student-section').style.display = 'none';
                const studentsGrid = document.getElementById('studentsGrid');
                console.log('Students grid element:', studentsGrid);
                studentsGrid.style.display = 'block';
                console.log('About to load users...');
                await loadUsers();
                console.log('About to load students...');
                await loadStudents();
                console.log('About to load teacher stats...');
                await loadTeacherStats();
            } else if (currentUser.role === 'teacher') {
                // Show teacher section and hide others
                document.querySelector('.admin-section').style.display = 'none';
                document.querySelector('.teacher-section').style.display = 'block';
                document.querySelector('.student-section').style.display = 'none';
                document.getElementById('studentsGrid').style.display = 'block';
                await loadTeacherStudents();
            } else if (currentUser.role === 'student') {
                // Show student section and hide others
                document.querySelector('.admin-section').style.display = 'none';
                document.querySelector('.teacher-section').style.display = 'none';
                document.querySelector('.student-section').style.display = 'block';
                document.getElementById('studentsGrid').style.display = 'none';
                await loadStudentProfile();
            }
        }

        function setRoleBasedUI() {
            // Set role badge
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
            
            // Add role class to dashboard
            dashboard.className = `dashboard active role-${currentUser.role}`;
            
            // Update dashboard title based on role
            const dashboardTitle = document.querySelector('.navbar-brand h2');
            console.log('Setting dashboard title for role:', currentUser.role);
            console.log('Current user name:', currentUser.name);
            console.log('Current user username:', currentUser.username);
            
            if (currentUser.role === 'student') {
                dashboardTitle.textContent = 'Complete Your Profile';
            } else if (currentUser.role === 'teacher') {
                const teacherName = currentUser.name || currentUser.username;
                console.log('Setting teacher name to:', teacherName);
                dashboardTitle.textContent = teacherName;
            } else {
                dashboardTitle.textContent = 'SehatMind Dashboard';
            }
            
            console.log('Final dashboard title:', dashboardTitle.textContent);
            
            // Show/hide role-specific elements
            const adminOnly = document.querySelectorAll('.admin-only');
            const adminTeacherOnly = document.querySelectorAll('.admin-teacher-only');
            const studentOnly = document.querySelectorAll('.student-only');
            
            adminOnly.forEach(el => el.style.display = currentUser.role === 'admin' ? 'inline-block' : 'none');
            adminTeacherOnly.forEach(el => el.style.display = (currentUser.role === 'admin' || currentUser.role === 'teacher') ? 'inline-block' : 'none');
            studentOnly.forEach(el => el.style.display = currentUser.role === 'student' ? 'inline-block' : 'none');
            
            // Hide action buttons for students but keep logout
            if (currentUser.role === 'student') {
                // Hide all buttons except logout
                const actionButtons = document.querySelectorAll('.navbar-actions .btn:not(#logoutBtn)');
                actionButtons.forEach(btn => btn.style.display = 'none');
                // Show only logout button
                document.getElementById('logoutBtn').style.display = 'inline-block';
            } else {
                // Show all buttons for admin and teacher
                const actionButtons = document.querySelectorAll('.navbar-actions .btn');
                actionButtons.forEach(btn => btn.style.display = 'inline-block');
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/dashboard/stats', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalStudents').textContent = stats.total_students || 0;
                    document.getElementById('highRiskStudents').textContent = stats.high_risk_students || 0;
                    document.getElementById('mediumRiskStudents').textContent = stats.medium_risk_students || 0;
                    document.getElementById('lowRiskStudents').textContent = stats.low_risk_students || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadTeachers() {
            try {
                const response = await fetch('/api/teachers', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    teachers = await response.json();
                    console.log('Teachers loaded:', teachers);
                    populateTeacherSelects();
                } else {
                    console.error('Failed to load teachers, status:', response.status);
                }
            } catch (error) {
                console.error('Error loading teachers:', error);
            }
        }

        function populateTeacherSelects() {
            // Populate student profile setup form
            const profileTeacherSelect = document.getElementById('profileTeacherSelect');
            if (profileTeacherSelect) {
                profileTeacherSelect.innerHTML = '<option value="">Choose your teacher...</option>';
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.username;
                    profileTeacherSelect.appendChild(option);
                });
            }

            // Populate main student form
            const teacherSelect = document.getElementById('teacherSelect');
            if (teacherSelect) {
                teacherSelect.innerHTML = '<option value="">Choose teacher...</option>';
                teachers.forEach(teacher => {
                    const option = document.createElement('option');
                    option.value = teacher.id;
                    option.textContent = teacher.username;
                    teacherSelect.appendChild(option);
                });
            }
        }

        async function loadStudents() {
            try {
                console.log('Loading students...');
                const response = await fetch('/api/students', {
                    credentials: 'include'
                });

                if (response.ok) {
                    students = await response.json();
                    console.log('Students loaded:', students);
                    console.log('Number of students:', students.length);
                    allStudents = students; // Store for filtering/sorting
                    renderStudents();
                } else {
                    console.error('Failed to load students, status:', response.status);
                    showAlert('Failed to load students', 'error');
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showAlert('Network error loading students', 'error');
            }
        }

        async function loadTeacherStudents() {
            try {
                console.log('Loading teacher students...');
                const response = await fetch('/api/students', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const allStudents = await response.json();
                    // Filter students to show only those assigned to current teacher
                    students = allStudents.filter(student => 
                        student.teacher_id === currentUser.id || 
                        student.owner_user_id === currentUser.id
                    );
                    console.log('Teacher students loaded:', students);
                    console.log('Number of teacher students:', students.length);
                    renderStudents();
                } else {
                    console.error('Failed to load teacher students, status:', response.status);
                    showAlert('Failed to load students', 'error');
                }
            } catch (error) {
                console.error('Error loading teacher students:', error);
                showAlert('Network error loading students', 'error');
            }
        }

        function renderStudents() {
            console.log('renderStudents called');
            console.log('allStudents:', allStudents);
            console.log('students:', students);
            
            const studentsToRender = allStudents.length > 0 ? allStudents : students;
            console.log('studentsToRender:', studentsToRender);
            console.log('studentsToRender.length:', studentsToRender.length);
            
            const studentsGrid = document.getElementById('studentsGrid');
            console.log('studentsGrid element:', studentsGrid);
            
            if (!studentsGrid) {
                console.error('studentsGrid element not found!');
                return;
            }
            
            if (studentsToRender.length === 0) {
                console.log('No students to render, showing empty message');
                studentsGrid.innerHTML = '<div class="text-center"><p>No students found. Add some students to get started!</p></div>';
                return;
            }

            console.log('Rendering students...');
            studentsGrid.innerHTML = studentsToRender.map(student => `
                <div class="student-card ${student.risk_level || 'unknown'}-risk" onclick="openStudentModal(${student.id})">
                    <div class="student-name">${student.name}</div>
                    <div class="student-info">
                        <div><strong>ID:</strong> ${student.student_id}</div>
                        <div><strong>Course:</strong> ${student.course}</div>
                        <div><strong>Semester:</strong> ${student.semester}</div>
                        <div><strong>CGPA:</strong> ${student.cgpa}</div>
                        <div><strong>Attendance:</strong> ${student.attendance_percentage}%</div>
                        ${student.teacher_name ? `<div><strong>Teacher:</strong> ${student.teacher_name}</div>` : ''}
                    </div>
                    <div class="risk-badge ${student.risk_level || 'unknown'}">${(student.risk_level || 'unknown').toUpperCase()} ${student.risk_percentage || 0}%</div>
                </div>
            `).join('');
            console.log('Students rendered successfully');
        }

        async function openStudentModal(studentId = null) {
            console.log('openStudentModal called with studentId:', studentId);
            console.log('studentModal element:', studentModal);
            
            // Show/hide teacher selection based on user role
            const teacherSelection = document.querySelector('.teacher-selection');
            if (currentUser && currentUser.role === 'teacher') {
                teacherSelection.style.display = 'none';
            } else {
                teacherSelection.style.display = 'block';
            }
            
            // First, clear the form completely
            document.getElementById('studentForm').reset();
            document.getElementById('studentId').value = '';
            document.getElementById('studentIdInput').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentCourse').value = '';
            document.getElementById('studentSemester').value = '';
            document.getElementById('attendancePercentage').value = '';
            document.getElementById('cgpa').value = '';
            document.getElementById('assignmentsSubmitted').value = '';
            document.getElementById('assignmentsTotal').value = '';
            
            if (studentId) {
                try {
                    // Fetch student data from API
                    const response = await fetch(`/api/students/${studentId}?t=${Date.now()}`);
                    
                    if (response.ok) {
                        const student = await response.json();
                        console.log('Student data received:', student);
                        console.log('Student name:', student.name);
                        console.log('Student ID:', student.id);
                        
                        // Force clear and repopulate form fields
                        setTimeout(() => {
                            document.getElementById('studentId').value = student.id;
                            document.getElementById('studentIdInput').value = student.student_id;
                            document.getElementById('studentName').value = student.name;
                            document.getElementById('studentEmail').value = student.email;
                            document.getElementById('studentPhone').value = student.phone || '';
                            document.getElementById('studentCourse').value = student.course;
                            document.getElementById('studentSemester').value = student.semester;
                            document.getElementById('attendancePercentage').value = student.attendance_percentage;
                            document.getElementById('cgpa').value = student.cgpa;
                            document.getElementById('assignmentsSubmitted').value = student.assignments_submitted;
                            document.getElementById('assignmentsTotal').value = student.assignments_total;
                            
                            // Set teacher selection
                            const teacherSelect = document.getElementById('teacherSelect');
                            if (teacherSelect && student.teacher_id) {
                                teacherSelect.value = student.teacher_id;
                            }
                            document.getElementById('modalTitle').textContent = 'Edit Student';
                            
                            console.log('Form populated with:', {
                                name: document.getElementById('studentName').value,
                                email: document.getElementById('studentEmail').value,
                                id: document.getElementById('studentId').value
                            });
                        }, 100);
                    } else {
                        console.error('Failed to fetch student data');
                        showAlert('Failed to load student data', 'error');
                    }
                } catch (error) {
                    console.error('Error fetching student data:', error);
                    showAlert('Error loading student data', 'error');
                }
            } else {
                document.getElementById('modalTitle').textContent = 'Add New Student';
            }
            studentModal.style.display = 'block';
            console.log('Modal display set to block, current style:', studentModal.style.display);
        }

        function closeStudentModal() {
            studentModal.style.display = 'none';
            // Clear the form when closing
            document.getElementById('studentForm').reset();
            document.getElementById('studentId').value = '';
            document.getElementById('studentIdInput').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('studentEmail').value = '';
            document.getElementById('studentPhone').value = '';
            document.getElementById('studentCourse').value = '';
            document.getElementById('studentSemester').value = '';
            document.getElementById('attendancePercentage').value = '';
            document.getElementById('cgpa').value = '';
            document.getElementById('assignmentsSubmitted').value = '';
            document.getElementById('assignmentsTotal').value = '';
        }

        // Add event listener for Add Student button
        document.getElementById('addStudentBtn').addEventListener('click', () => {
            console.log('Add Student button clicked');
            openStudentModal();
        });

        function openImportModal() {
            importModal.style.display = 'block';
        }

        async function handleStudentSubmit(e) {
            e.preventDefault();
            const formData = new FormData(studentForm);
            const data = Object.fromEntries(formData);
            const studentId = document.getElementById('studentId').value;

            try {
                const url = studentId ? `/api/students/${studentId}` : '/api/students';
                const method = studentId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success message with auto-generated password info
                    if (result.student_id && result.password) {
                        showAlert(`Student added successfully!<br><strong>Login Credentials:</strong><br>Username: ${result.student_id}<br>Password: ${result.password}`, 'success');
                    } else {
                        showAlert(result.message);
                    }
                    closeStudentModal();
                    // Load students based on user role
                    if (currentUser.role === 'teacher') {
                        await loadTeacherStudents();
                    } else {
                        await loadStudents();
                    }
                    await loadStats();
                } else {
                    showAlert(result.error || 'Operation failed', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function handleDeleteStudent() {
            const studentId = document.getElementById('studentId').value;
            if (!studentId) return;

            if (confirm('Are you sure you want to delete this student?')) {
                try {
                const response = await fetch(`/api/students/${studentId}`, {
                    method: 'DELETE'
                });

                    const result = await response.json();

                    if (response.ok) {
                        showAlert(result.message);
                        closeStudentModal();
                        // Load students based on user role
                        if (currentUser.role === 'teacher') {
                            await loadTeacherStudents();
                        } else {
                            await loadStudents();
                        }
                        await loadStats();
                    } else {
                        showAlert(result.error || 'Delete failed', 'error');
                    }
                } catch (error) {
                    showAlert('Network error. Please try again.', 'error');
                }
            }
        }

        async function predictRisk() {
            try {
                const response = await fetch('/api/predict-risk', {
                    method: 'POST'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(result.message);
                    await loadStudents();
                    await loadStats();
                } else {
                    showAlert(result.error || 'Prediction failed', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function handleImport(e) {
            e.preventDefault();
            const formData = new FormData(importForm);
            
            try {
                const response = await fetch('/api/import-students', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(result.message);
                    importModal.style.display = 'none';
                    importForm.reset();
                    // Load students based on user role
                    if (currentUser.role === 'teacher') {
                        await loadTeacherStudents();
                    } else {
                        await loadStudents();
                    }
                    await loadStats();
                } else {
                    showAlert(result.error || 'Import failed', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        }

        async function loadTeacherStats() {
            try {
                console.log('Loading teacher stats...');
                const response = await fetch('/api/admin/teacher-stats', {
                    credentials: 'include'
                });
                
                console.log('Teacher stats response status:', response.status);
                
                if (!response.ok) {
                    console.error('Teacher stats response not ok:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    return;
                }
                
                const teachers = await response.json();
                console.log('Teachers data:', teachers);
                
                const teacherStatsContainer = document.getElementById('teacherStats');
                if (!teacherStatsContainer) {
                    console.error('Teacher stats container not found');
                    return;
                }
                
                if (teachers.length === 0) {
                    console.log('No teachers found');
                    teacherStatsContainer.innerHTML = '<p>No teachers found</p>';
                    return;
                }
                
                teacherStatsContainer.innerHTML = teachers.map(teacher => `
                    <div class="teacher-card" onclick="viewTeacherStudents(${teacher.id}, '${teacher.username}')" style="cursor: pointer;">
                        <h3>${teacher.username}</h3>
                        <p>Email: ${teacher.email}</p>
                        <div class="teacher-stats">
                            <div class="stat-item">
                                <span class="stat-label">Total Students:</span>
                                <span class="stat-value">${teacher.student_count}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">High Risk:</span>
                                <span class="stat-value high-risk">${teacher.high_risk_count}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Medium Risk:</span>
                                <span class="stat-value medium-risk">${teacher.medium_risk_count}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Low Risk:</span>
                                <span class="stat-value low-risk">${teacher.low_risk_count}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading teacher stats:', error);
                const teacherStatsContainer = document.getElementById('teacherStats');
                if (teacherStatsContainer) {
                    teacherStatsContainer.innerHTML = '<p>Error loading teacher stats: ' + error.message + '</p>';
                }
            }
        }

        // Role-specific functions
        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    credentials: 'include'
                });

                if (response.ok) {
                    const users = await response.json();
                    renderUsers(users);
                } else {
                    showAlert('Failed to load users', 'error');
                }
            } catch (error) {
                showAlert('Network error loading users', 'error');
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td><span class="role-tag ${user.role}">${user.role}</span></td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn" onclick="editUser(${user.id}, '${user.username}', '${user.email}', '${user.role}')">Edit</button>
                        <button class="btn" style="background: #dc3545;" onclick="deleteUser(${user.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadStudentProfile() {
            try {
                const response = await fetch('/api/students');

                if (response.ok) {
                    const students = await response.json();
                    const student = students.find(s => s.email === currentUser.email);
                    if (student) {
                        // Store current student ID for editing
                        currentStudentId = student.id;
                        
                        // Student profile exists, show profile display and hide stats
                        document.getElementById('studentProfileForm').style.display = 'none';
                        document.getElementById('studentProfileDisplay').style.display = 'block';
                        document.getElementById('studentRecommendations').style.display = 'block';
                        document.getElementById('statsGrid').style.display = 'none';
                        document.getElementById('studentsGrid').style.display = 'none';
                        renderStudentProfile(student);
                        generateRecommendations(student);
                    } else {
                        // Student profile doesn't exist, show setup form and hide stats
                        document.getElementById('studentProfileDisplay').style.display = 'none';
                        document.getElementById('studentProfileForm').style.display = 'block';
                        document.getElementById('studentRecommendations').style.display = 'none';
                        document.getElementById('statsGrid').style.display = 'none';
                        document.getElementById('studentsGrid').style.display = 'none';
                    }
                } else {
                    showAlert('Failed to load student profile', 'error');
                }
            } catch (error) {
                showAlert('Network error loading student profile', 'error');
            }
        }

        function renderStudentProfile(student) {
            document.getElementById('profileStudentName').textContent = student.name;
            document.getElementById('profileStudentEmail').textContent = student.email;
            document.getElementById('profileStudentCourse').textContent = `${student.course} - Semester ${student.semester}`;
            
            // Update the main risk display above buttons
            const riskDisplay = document.getElementById('studentRiskDisplay');
            riskDisplay.textContent = `${(student.risk_level || 'unknown').toUpperCase()} ${student.risk_percentage || 0}%`;
            riskDisplay.className = `risk-display risk-badge ${student.risk_level || 'unknown'}`;
        }

        function generateRecommendations(student) {
            const recommendations = [];
            const riskPercentage = student.risk_percentage || 0;
            
            // CGPA Recommendations
            if (student.cgpa < 8.0) {
                recommendations.push({
                    category: 'Academic Performance',
                    priority: 'high',
                    title: 'Improve CGPA',
                    current: student.cgpa,
                    target: 8.0,
                    actions: [
                        `Focus on scoring 80%+ in all upcoming exams`,
                        `Complete all assignments with 90%+ accuracy`,
                        `Attend all lectures and take detailed notes`,
                        `Form study groups with high-performing classmates`,
                        `Seek help from professors during office hours`,
                        `Review previous exam papers and practice regularly`
                    ]
                });
            }
            
            // Attendance Recommendations
            if (student.attendance_percentage < 90) {
                recommendations.push({
                    category: 'Attendance',
                    priority: 'high',
                    title: 'Improve Attendance',
                    current: student.attendance_percentage,
                    target: 90,
                    actions: [
                        `Attend all classes without fail (target: 100% attendance)`,
                        `Set daily reminders for class schedules`,
                        `Join study groups to stay motivated`,
                        `Communicate with professors if you miss any class`,
                        `Make up for missed classes by reviewing notes with classmates`
                    ]
                });
            }
            
            // Assignment Completion Recommendations
            const assignmentRate = student.assignments_total > 0 ? (student.assignments_submitted / student.assignments_total) * 100 : 0;
            if (assignmentRate < 95) {
                recommendations.push({
                    category: 'Assignments',
                    priority: 'medium',
                    title: 'Complete All Assignments',
                    current: assignmentRate,
                    target: 95,
                    actions: [
                        `Submit all pending assignments immediately`,
                        `Set weekly deadlines for assignment completion`,
                        `Start assignments 3-4 days before due date`,
                        `Use assignment tracking apps or calendars`,
                        `Seek help from TAs or professors for difficult assignments`,
                        `Form study groups to discuss assignment problems`
                    ]
                });
            }
            
            // Exam Performance Recommendations
            if (student.exam_attempts > 1) {
                recommendations.push({
                    category: 'Exam Performance',
                    priority: 'high',
                    title: 'Reduce Exam Retakes',
                    current: student.exam_attempts,
                    target: 1,
                    actions: [
                        `Create a comprehensive study schedule 2 weeks before exams`,
                        `Practice with previous year question papers`,
                        `Focus on understanding concepts rather than memorization`,
                        `Take mock tests to identify weak areas`,
                        `Get adequate sleep (7-8 hours) before exams`,
                        `Use active learning techniques like flashcards and mind maps`
                    ]
                });
            }
            
            // Study Hours Recommendations
            if (student.study_hours < 6) {
                recommendations.push({
                    category: 'Study Habits',
                    priority: 'medium',
                    title: 'Increase Study Hours',
                    current: student.study_hours,
                    target: 6,
                    actions: [
                        `Study for at least 6 hours daily (2 hours per subject)`,
                        `Create a fixed study schedule and stick to it`,
                        `Use Pomodoro technique (25 min study, 5 min break)`,
                        `Find a quiet study space with minimal distractions`,
                        `Join study groups for collaborative learning`,
                        `Take regular breaks to maintain focus and productivity`
                    ]
                });
            }
            
            // Financial Support Recommendations
            if (student.family_income < 80000) {
                recommendations.push({
                    category: 'Financial Support',
                    priority: 'low',
                    title: 'Explore Financial Aid',
                    current: student.family_income,
                    target: 'N/A',
                    actions: [
                        `Apply for merit-based scholarships`,
                        `Look into need-based financial aid programs`,
                        `Consider part-time work-study opportunities`,
                        `Research external scholarship opportunities`,
                        `Apply for educational loans with low interest rates`,
                        `Look for paid internship opportunities in your field`
                    ]
                });
            }
            
            // General Performance Recommendations
            if (riskPercentage > 60) {
                recommendations.push({
                    category: 'Overall Performance',
                    priority: 'high',
                    title: 'General Improvement Strategy',
                    current: riskPercentage,
                    target: 40,
                    actions: [
                        `Set SMART goals (Specific, Measurable, Achievable, Relevant, Time-bound)`,
                        `Track your progress weekly and adjust strategies`,
                        `Maintain a positive mindset and stay motivated`,
                        `Seek mentorship from senior students or alumni`,
                        `Participate in extracurricular activities to build confidence`,
                        `Regularly communicate with academic advisors`
                    ]
                });
            }
            
            // Render recommendations
            const recommendationsContainer = document.getElementById('recommendationsList');
            if (recommendations.length > 0) {
                recommendationsContainer.innerHTML = recommendations.map(rec => `
                    <div class="recommendation-card ${rec.priority}">
                        <div class="recommendation-header">
                            <h4>${rec.title}</h4>
                            <span class="priority-badge ${rec.priority}">${rec.priority.toUpperCase()}</span>
                        </div>
                        <div class="recommendation-progress">
                            <div class="progress-info">
                                <span>Current: ${rec.current}${rec.target !== 'N/A' ? `/${rec.target}` : ''}</span>
                                ${rec.target !== 'N/A' ? `<span>Target: ${rec.target}</span>` : ''}
                            </div>
                        </div>
                        <div class="recommendation-actions">
                            <h5>Action Plan:</h5>
                            <ul>
                                ${rec.actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `).join('');
            } else {
                recommendationsContainer.innerHTML = `
                    <div class="recommendation-card success">
                        <div class="recommendation-header">
                            <h4>Excellent Performance!</h4>
                            <span class="priority-badge success">EXCELLENT</span>
                        </div>
                        <p>You're performing exceptionally well! Keep up the great work and maintain your current standards.</p>
                    </div>
                `;
            }
        }

        // Event listeners for role-specific buttons


        document.getElementById('viewAllStudentsBtn')?.addEventListener('click', () => {
            // Show all students section and hide specific teacher section
            document.getElementById('allStudentsSection').style.display = 'block';
            document.getElementById('specificTeacherStudents').style.display = 'none';
            document.getElementById('teacherStats').style.display = 'grid';
            document.getElementById('viewAllStudentsBtn').style.display = 'none';
            loadStudents();
        });

        document.getElementById('backToStatsBtn')?.addEventListener('click', () => {
            // Go back to teacher stats
            document.getElementById('specificTeacherStudents').style.display = 'none';
            document.getElementById('allStudentsSection').style.display = 'none';
            document.getElementById('teacherStats').style.display = 'grid';
            document.getElementById('viewAllStudentsBtn').style.display = 'none';
        });

        // Risk filter functionality
        document.getElementById('riskFilter')?.addEventListener('change', (e) => {
            filterStudentsByRisk(e.target.value);
        });


        // View specific teacher's students
        async function viewTeacherStudents(teacherId, teacherName) {
            try {
                // Update the title
                document.getElementById('specificTeacherTitle').textContent = `Students of ${teacherName}`;
                
                // Show specific teacher section and hide teacher stats
                document.getElementById('specificTeacherStudents').style.display = 'block';
                document.getElementById('teacherStats').style.display = 'none';
                document.getElementById('viewAllStudentsBtn').style.display = 'block';
                
                // Load students for this specific teacher
                const response = await fetch(`/api/students?teacher_id=${teacherId}`);
                
                if (response.ok) {
                    const students = await response.json();
                    renderSpecificTeacherStudents(students);
                } else {
                    console.error('Failed to load teacher students');
                    document.getElementById('specificTeacherStudentsGrid').innerHTML = '<p>Failed to load students</p>';
                }
            } catch (error) {
                console.error('Error loading teacher students:', error);
                document.getElementById('specificTeacherStudentsGrid').innerHTML = '<p>Error loading students</p>';
            }
        }

        // Render specific teacher's students
        function renderSpecificTeacherStudents(students) {
            const container = document.getElementById('specificTeacherStudentsGrid');
            
            if (students.length === 0) {
                container.innerHTML = '<p>No students found for this teacher</p>';
                return;
            }
            
            container.innerHTML = students.map(student => `
                <div class="student-card ${student.risk_level || 'unknown'}-risk" onclick="openStudentModal(${student.id})">
                    <div class="student-name">${student.name}</div>
                    <div class="student-info">
                        <div><strong>ID:</strong> ${student.student_id}</div>
                        <div><strong>Course:</strong> ${student.course}</div>
                        <div><strong>Semester:</strong> ${student.semester}</div>
                        <div><strong>CGPA:</strong> ${student.cgpa}</div>
                        <div><strong>Attendance:</strong> ${student.attendance_percentage}%</div>
                        ${student.teacher_name ? `<div><strong>Teacher:</strong> ${student.teacher_name}</div>` : ''}
                    </div>
                    <div class="risk-badge ${student.risk_level || 'unknown'}">${(student.risk_level || 'unknown').toUpperCase()} ${student.risk_percentage || 0}%</div>
                </div>
            `).join('');
        }

        // Store all students for filtering/sorting
        let allStudents = [];
        
        // Store current student ID for editing
        let currentStudentId = null;

        // Filter students by risk level
        function filterStudentsByRisk(riskLevel) {
            const container = document.getElementById('studentsGrid');
            let filteredStudents = allStudents;
            
            if (riskLevel) {
                filteredStudents = allStudents.filter(student => student.risk_level === riskLevel);
            }
            
            if (filteredStudents.length === 0) {
                container.innerHTML = '<div class="text-center"><p>No students found with the selected risk level</p></div>';
                return;
            }
            
            container.innerHTML = filteredStudents.map(student => `
                <div class="student-card ${student.risk_level || 'unknown'}-risk" onclick="openStudentModal(${student.id})">
                    <div class="student-name">${student.name}</div>
                    <div class="student-info">
                        <div><strong>ID:</strong> ${student.student_id}</div>
                        <div><strong>Course:</strong> ${student.course}</div>
                        <div><strong>Semester:</strong> ${student.semester}</div>
                        <div><strong>CGPA:</strong> ${student.cgpa}</div>
                        <div><strong>Attendance:</strong> ${student.attendance_percentage}%</div>
                        ${student.teacher_name ? `<div><strong>Teacher:</strong> ${student.teacher_name}</div>` : ''}
                    </div>
                    <div class="risk-badge ${student.risk_level || 'unknown'}">${(student.risk_level || 'unknown').toUpperCase()} ${student.risk_percentage || 0}%</div>
                </div>
            `).join('');
        }




        // Predict Risk functions
        function closePredictRiskModal() {
            document.getElementById('predictRiskModal').style.display = 'none';
            document.getElementById('predictRiskForm').reset();
            document.getElementById('riskResult').style.display = 'none';
        }

        function calculateRiskPercentage(cgpa, attendance, assignments) {
            // Calculate assignment completion percentage
            const assignmentPercentage = (assignments / 10) * 100; // Assignments out of 10
            
            // Define risk boundaries based on CGPA, attendance, and assignment completion
            // High Risk: CGPA < 3.0 AND attendance 0-30% AND assignment 0-30%
            // Medium Risk: CGPA 3.0-5.0 AND attendance 30-50% AND assignment 30-50%
            // Low Risk: CGPA 5.0-8.0 AND attendance 50-80% AND assignment 50-80%
            // Safe: CGPA 8.0-10.0 AND attendance 80-100% AND assignment 80-100%
            
            // Check for High Risk conditions
            if (cgpa < 3.0 && attendance <= 30 && assignmentPercentage <= 30) {
                return 85; // High risk percentage
            }
            
            // Check for Medium Risk conditions
            else if (cgpa >= 3.0 && cgpa < 5.0 && attendance > 30 && attendance <= 50 && assignmentPercentage > 30 && assignmentPercentage <= 50) {
                return 65; // Medium risk percentage
            }
            
            // Check for Low Risk conditions
            else if (cgpa >= 5.0 && cgpa < 8.0 && attendance > 50 && attendance <= 80 && assignmentPercentage > 50 && assignmentPercentage <= 80) {
                return 35; // Low risk percentage
            }
            
            // Check for Safe conditions
            else if (cgpa >= 8.0 && cgpa <= 10.0 && attendance >= 80 && attendance <= 100 && assignmentPercentage >= 80 && assignmentPercentage <= 100) {
                // Perfect scores should get the lowest risk
                if (cgpa === 10.0 && attendance === 100 && assignmentPercentage === 100) {
                    return 5; // Perfect scores get minimal risk
                } else {
                    return 15; // Safe risk percentage
                }
            }
            
            // For students who don't fit exact boundaries, calculate based on proximity
            else {
                // Calculate weighted average based on the three factors
                // Each factor contributes equally to the final risk assessment
                
                // Normalize CGPA to 0-100 scale (0 = worst, 100 = best)
                const cgpaScore = Math.min(100, (cgpa / 10.0) * 100);
                
                // Attendance and assignment scores are already percentages
                const attendanceScore = attendance;
                const assignmentScore = assignmentPercentage;
                
                // Calculate average of the three scores
                const averageScore = (cgpaScore + attendanceScore + assignmentScore) / 3;
                
                // Convert to risk percentage (higher score = lower risk)
                let riskPercentage = 100 - averageScore;
                
                // Apply some adjustments for better distribution
                if (riskPercentage < 20) {
                    riskPercentage = 15; // Minimum risk for high performers
                } else if (riskPercentage > 85) {
                    riskPercentage = 85; // Maximum risk cap
                }
                
                return Math.max(5, Math.min(85, riskPercentage)); // Clamp between 5-85
            }
        }

        function getRiskLevel(percentage) {
            if (percentage >= 60) return { level: 'HIGH', color: '#dc3545', description: 'Student is at high risk of dropping out' };
            if (percentage >= 40) return { level: 'MEDIUM', color: '#ffc107', description: 'Student shows moderate risk factors' };
            if (percentage >= 20) return { level: 'LOW', color: '#28a745', description: 'Student is at low risk' };
            return { level: 'SAFE', color: '#17a2b8', description: 'Student is performing well and safe' };
        }

        async function handlePredictRisk(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            const cgpa = parseFloat(data.cgpa);
            const attendance = parseFloat(data.attendance);
            const assignments = parseFloat(data.assignments);
            
            // Calculate risk percentage
            const riskPercentage = calculateRiskPercentage(cgpa, attendance, assignments);
            const riskInfo = getRiskLevel(riskPercentage);
            
            // Display results
            document.getElementById('riskPercentage').textContent = `Risk Score: ${riskPercentage}%`;
            document.getElementById('riskLevel').textContent = `Risk Level: ${riskInfo.level}`;
            document.getElementById('riskDescription').textContent = riskInfo.description;
            
            // Style the result based on risk level
            const riskResult = document.getElementById('riskResult');
            riskResult.style.backgroundColor = riskInfo.color + '20';
            riskResult.style.border = `2px solid ${riskInfo.color}`;
            riskResult.style.color = riskInfo.color;
            riskResult.style.display = 'block';
        }

        // Add User functions
        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
            document.getElementById('addUserForm').reset();
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('User added successfully!');
                    closeAddUserModal();
                    await loadUsers();
                } else {
                    showAlert(result.error || 'Failed to add user', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        }

        // Edit User functions
        function editUser(userId, username, email, role) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editEmail').value = email;
            document.getElementById('editRole').value = role;
            document.getElementById('editUserModal').style.display = 'block';
        }

        function closeEditUserModal() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) {
                return;
            }

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('User deleted successfully!');
                    await loadUsers();
                } else {
                    showAlert(result.error || 'Failed to delete user', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        }


        // Handle Edit User
        async function handleEditUser(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            const userId = document.getElementById('editUserId').value;

            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert('User updated successfully!');
                    closeEditUserModal();
                    await loadUsers();
                } else {
                    showAlert(result.error || 'Failed to update user', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        }


        document.getElementById('addUserBtn')?.addEventListener('click', () => {
            document.getElementById('addUserModal').style.display = 'block';
        });

        document.getElementById('predictRiskBtn')?.addEventListener('click', () => {
            document.getElementById('predictRiskModal').style.display = 'block';
        });

        document.getElementById('predictRiskForm')?.addEventListener('submit', handlePredictRisk);

        document.getElementById('editProfileBtn')?.addEventListener('click', () => {
            if (currentStudentId) {
                openStudentModal(currentStudentId);
            } else {
                showAlert('Student profile not loaded. Please refresh the page.', 'error');
            }
        });

        document.getElementById('viewProgressBtn')?.addEventListener('click', () => {
            if (currentStudentId) {
                showStudentProgress();
            } else {
                showAlert('Student profile not loaded. Please refresh the page.', 'error');
            }
        });

        // Profile picture functionality
        document.getElementById('changeProfileBtn')?.addEventListener('click', () => {
            document.getElementById('profileImageInput').click();
        });

        document.getElementById('profileImageInput')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const profileImage = document.getElementById('profileImage');
                    const defaultAvatar = document.getElementById('defaultAvatar');
                    
                    profileImage.src = e.target.result;
                    profileImage.style.display = 'block';
                    defaultAvatar.style.display = 'none';
                    
                    // Store in localStorage for persistence
                    localStorage.setItem('profileImage', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // Load profile image from localStorage on page load
        window.addEventListener('load', () => {
            const savedImage = localStorage.getItem('profileImage');
            if (savedImage) {
                const profileImage = document.getElementById('profileImage');
                const defaultAvatar = document.getElementById('defaultAvatar');
                
                profileImage.src = savedImage;
                profileImage.style.display = 'block';
                defaultAvatar.style.display = 'none';
            }
        });

        // Student Progress Functions
        async function showStudentProgress() {
            try {
                const response = await fetch(`/api/students/${currentStudentId}`);
                
                if (response.ok) {
                    const student = await response.json();
                    populateProgressModal(student);
                    document.getElementById('studentProgressModal').style.display = 'block';
                } else {
                    showAlert('Failed to load student progress data', 'error');
                }
            } catch (error) {
                showAlert('Network error loading progress data', 'error');
            }
        }

        function populateProgressModal(student) {
            // Update metrics
            document.getElementById('progressCGPA').textContent = student.cgpa;
            document.getElementById('progressAttendance').textContent = `${student.attendance_percentage}%`;
            
            const assignmentRate = student.assignments_total > 0 ? 
                Math.round((student.assignments_submitted / student.assignments_total) * 100) : 0;
            document.getElementById('progressAssignments').textContent = `${assignmentRate}%`;
            
            const riskDisplay = document.getElementById('progressRisk');
            riskDisplay.textContent = `${(student.risk_level || 'unknown').toUpperCase()} ${student.risk_percentage || 0}%`;
            riskDisplay.className = `risk-badge ${student.risk_level || 'unknown'}`;
            
            // Generate progress recommendations
            const recommendations = generateProgressRecommendations(student);
            document.getElementById('progressRecommendations').innerHTML = recommendations;
            
            // Generate next steps
            const nextSteps = generateNextSteps(student);
            document.getElementById('progressNextSteps').innerHTML = nextSteps;
        }

        function generateProgressRecommendations(student) {
            const recommendations = [];
            
            if (student.cgpa < 8.0) {
                recommendations.push(`
                    <div class="recommendation-card medium">
                        <div class="recommendation-header">
                            <h4>Academic Performance</h4>
                            <span class="priority-badge medium">MEDIUM</span>
                        </div>
                        <p>Your CGPA is ${student.cgpa}. Focus on improving grades in upcoming exams.</p>
                    </div>
                `);
            }
            
            if (student.attendance_percentage < 90) {
                recommendations.push(`
                    <div class="recommendation-card high">
                        <div class="recommendation-header">
                            <h4>Attendance</h4>
                            <span class="priority-badge high">HIGH</span>
                        </div>
                        <p>Your attendance is ${student.attendance_percentage}%. Regular attendance is crucial for academic success.</p>
                    </div>
                `);
            }
            
            const assignmentRate = student.assignments_total > 0 ? 
                (student.assignments_submitted / student.assignments_total) * 100 : 0;
            if (assignmentRate < 95) {
                recommendations.push(`
                    <div class="recommendation-card medium">
                        <div class="recommendation-header">
                            <h4>Assignment Completion</h4>
                            <span class="priority-badge medium">MEDIUM</span>
                        </div>
                        <p>You've completed ${Math.round(assignmentRate)}% of assignments. Aim for 100% completion.</p>
                    </div>
                `);
            }
            
            return recommendations.length > 0 ? recommendations.join('') : 
                '<div class="recommendation-card success"><p>Great job! You\'re performing well in all areas.</p></div>';
        }

        function generateNextSteps(student) {
            const steps = [];
            
            if (student.cgpa < 8.0) {
                steps.push('<li>ðŸ“š Create a study schedule for each subject</li>');
                steps.push('<li>ðŸŽ¯ Focus on weak subjects first</li>');
                steps.push('<li>ðŸ‘¥ Join study groups for better understanding</li>');
            }
            
            if (student.attendance_percentage < 90) {
                steps.push('<li>â° Set daily reminders for classes</li>');
                steps.push('<li>ðŸ“ Take detailed notes during lectures</li>');
                steps.push('<li>ðŸ¤ Partner with classmates for accountability</li>');
            }
            
            if (student.exam_attempts > 1) {
                steps.push('<li>ðŸ“– Start exam preparation 2 weeks early</li>');
                steps.push('<li>ðŸ“ Practice with previous year papers</li>');
                steps.push('<li>ðŸ’¤ Maintain good sleep schedule before exams</li>');
            }
            
            if (student.study_hours < 6) {
                steps.push('<li>â° Allocate 6+ hours daily for studies</li>');
                steps.push('<li>ðŸ… Use Pomodoro technique for focused study</li>');
                steps.push('<li>ðŸ“± Minimize distractions during study time</li>');
            }
            
            if (steps.length === 0) {
                steps.push('<li>ðŸŽ‰ Continue maintaining excellent performance!</li>');
                steps.push('<li>ðŸ“ˆ Set higher goals for next semester</li>');
                steps.push('<li>ðŸŒŸ Help other students improve their performance</li>');
            }
            
            return steps.join('');
        }

        // Close progress modal
        document.querySelector('#studentProgressModal .close')?.addEventListener('click', () => {
            document.getElementById('studentProgressModal').style.display = 'none';
        });

        // Student profile setup form
        document.getElementById('studentProfileSetupForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            
            try {
                const response = await fetch('/api/students', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    // Show success message with auto-generated password info
                    if (result.student_id && result.password) {
                        showAlert(`Profile created successfully!<br><strong>Login Credentials:</strong><br>Username: ${result.student_id}<br>Password: ${result.password}`, 'success');
                    } else {
                        showAlert('Profile created successfully!');
                    }
                    await loadStudentProfile(); // Reload to show profile display
                } else {
                    showAlert(result.error || 'Failed to create profile', 'error');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'error');
            }
        });

        // Check for existing session on page load
        window.addEventListener('load', () => {
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                loadDashboard();
            }
        });
    </script>
</body>
</html>
